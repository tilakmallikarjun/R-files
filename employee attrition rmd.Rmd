---
title: "Employee attrition"
author: "Mallikarjun Tilak"
date: "1/9/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.


Installing required libraries
```{r}
library(tidyverse)
library(mice)
library(dplyr)
library(ggcorrplot)
library(caret)
library(ggplot2)
library(rpart)
library(rpart.plot)
library(tree)
library(ggthemes)
library(randomForest)
library(xgboost)
```
Loading the data and checking for null or NA values
```{r}
train_data<-read.csv("train_MpHjUjU.csv")
nas<- lapply(train_data, function(x){length(which(is.na(x)))})
blanks<- lapply(train_data, function(x){length(which(x==""))})
```
Date formatting of the variables associated with date

```{r}
train_data$MMM.YY <- as.Date(train_data$MMM.YY, format= "%Y-%m-%d")
train_data$LastWorkingDate <- as.Date(train_data$LastWorkingDate, format= "%Y-%m-%d")
train_data$Dateofjoining <- as.Date(train_data$Dateofjoining, format= "%Y-%m-%d")
train_data$DaysInCompany<-train_data$MMM.YY-train_data$Dateofjoining
```
#encoding target variable
```{r}


train_data$lyd <- ifelse(is.na(train_data$LastWorkingDate), "No", "Yes")

attrition_data<-subset(train_data, lyd == "Yes")
lyd_data<-select(attrition_data, c(Emp_ID, LastWorkingDate))
```

```{r}
##use merge"
train_data<-merge(train_data,lyd_data,by="Emp_ID" ,all.x = TRUE)
train_data$daysb4lastworkingdate<-train_data$LastWorkingDate.y- train_data$MMM.YY
```

```{r}
###Encoding attrition Risk##
train_data$attrition<-ifelse(train_data$daysb4lastworkingdate < 180, "Yes", "No")
train_data$attrition[is.na(train_data$attrition)]<- "No"
```


```{r}
train_data$DaysInCompany[train_data$DaysInCompany<0]<-0
train_data$attrition<-as.factor(train_data$attrition)

```
```{r}

cols<- c( "Gender", "City","Education_Level")

train_data[cols]<-lapply(train_data[cols], factor)
#split date
train_data$date<-train_data$MMM.YY
train_data<-train_data%>% separate(date, sep="-",into=c("year","month", "day") )
train_data$month<- as.numeric(train_data$month)

train_data$pastquarter<- train_data$month -3
past_quarter_data<-select(train_data, c("Emp_ID","Quarterly.Rating","month"))

names(past_quarter_data)[names(past_quarter_data) == 'month'] <- 'pastquarter'
train_data<-merge(train_data,past_quarter_data,  by=c("Emp_ID", "pastquarter"))

```

## USE different DATA for submission##
```{r}

test<-read.csv("test_hXY9mYw.csv")

testfull_df<-subset(train_data, Emp_ID %in% test$Emp_ID)
#test_df<-distinct(testfull_df,Emp_ID)
#testfull_df$DaysInCompany<-testfull_df$DaysInCompany+180
```

```{r}
uniq_Emp_id <- testfull_df %>% group_by(Emp_ID) %>% summarise(Total.Business.Value = sum(Total.Business.Value))
testfull_df["Total.Business.Value"]<- NULL
merged<-merge(testfull_df, uniq_Emp_id, by= "Emp_ID")
merged$MMM.YY <- as.Date(merged$MMM.YY, format= "%Y-%m-%d")
test_df<-merged %>% 
  group_by(Emp_ID) %>%
  dplyr::slice(which.max(as.Date(MMM.YY, '%m/%d/%Y')))
```

```{r}
#Remove Test Employee IDs from training set#
#train_data <- train_data[ ! train_data$Emp_ID %in% test$Emp_ID, ]

####partitioning data
df<-train_data %>% filter(MMM.YY < "2017-07-01" )

```

```{r}

#plotting attrition data
df %>%
  group_by(attrition) %>%
  tally() %>%
  ggplot(aes(x = attrition, y = n,fill=attrition)) +
  geom_bar(stat = "identity") +
  theme_minimal()+
  labs(x="attrition", y="Count of Attrition")+
  ggtitle("Attrition")+
  geom_text(aes(label = n), vjust = -0.5, position = position_dodge(0.9))

```

```{r}
## variation of attrition with age
ggplot(data=df, aes(Age))+ geom_histogram(breaks=seq(20, 50, by=2),  col="red", aes(fill=..count..))+labs(x="Age", y="Count")
## variation of attrition by quarterly rating
ggplot(df,aes(Quarterly.Rating.y,fill=attrition))+geom_bar()

```
## variation of attrition w.r.t. education and income
```{r}
avg.income<-df %>% select(Education_Level, Salary, attrition)%>% group_by(Education_Level, attrition) %>% summarize(avg.inc=mean(Salary))%>%
ggplot(aes(x=reorder(Education_Level, avg.inc), y=avg.inc, fill=attrition)) + geom_bar(stat="identity", position="dodge") + facet_wrap(~attrition) + 
  theme_minimal() + theme(axis.text.x = element_text(angle = 90), plot.title=element_text(hjust=0.5)) + 
  scale_fill_manual(values=c("lightgreen", "tomato2")) + 
  labs(y="Average Income", x="Education_Level", title="Average Income by Education_Level \n and Attrition Status") + 
  geom_text(aes(x=Education_Level, y=0.01, label= paste0("$ ", round(avg.inc,2))),
            hjust=-0.5, vjust=0, size=3, 
            colour="black", fontface="bold",
            angle=90)
avg.income
options(repr.plot.width=10, repr.plot.height=7) 

nums <- select_if(df, is.numeric)
corr <- round(cor(nums), 1)
ggcorrplot(corr, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="square", 
           colors = c("tomato2", "white", "#01A9DB"), 
           title="Correlogram Employee Attritions", 
           ggtheme=theme_minimal())



```
## Remove unwanted colum
```{r}
## Remove unwanted columns
cols<-c("MMM.YY","LastWorkingDate", "Dateofjoining","LastWorkingDate.x","LastWorkingDate.y","lyd","daysb4lastworkingdate")
df[cols]<-NULL
test_df[cols]<-NULL
```
##%%%%XG BOOST%%
```{r}


cols<-c("Salary","Quarterly.Rating.y","Joining.Designation","Total.Business.Value","Designation","DaysInCompany","Age")
df[cols]<-lapply(df[cols], as.numeric)
test_df[cols]<-lapply(test_df[cols], as.numeric)
df_numeric<-df[cols]
test_df_numeric<-test_df[cols]
```
### One hot Encoding for df
```{r}


Gender_numeric <- model.matrix(~Gender-1,df)
City_numeric <- model.matrix(~City-1,df)
Education_level_numeric <- model.matrix(~Education_Level-1,df)
df_numeric<-cbind(df_numeric,Gender_numeric,City_numeric,Education_level_numeric)
df_matrix<-data.matrix(df_numeric)

```

```{r}
#onehot encoding for test
Gender_numeric <- model.matrix(~Gender-1,test_df)
City_numeric <- model.matrix(~City-1,test_df)
Education_level_numeric <- model.matrix(~Education_Level-1,test_df)
test_df_numeric<-cbind(test_df_numeric,Gender_numeric,City_numeric,Education_level_numeric)
test_df_matrix<-data.matrix(test_df_numeric)


df$attrition <- ifelse(df$attrition == "Yes", 1, 0)
test_df$attrition<-ifelse(test_df$attrition == "Yes", 1, 0)

#labels
train_dat<-df_matrix
test_dat<- test_df_matrix
train_labels<-df$attrition
test_labels<-test_df$attrition
```
#converting to Dmatrix
```{r}

dtrain <- xgb.DMatrix(data = train_dat, label= train_labels)
dtest <- xgb.DMatrix(data = test_dat, label= test_labels)

model <- xgboost(data = dtrain, # the data   
                 nround = 20, # max number of boosting iterations
                 objective = "binary:logistic")
pred <- predict(model, dtest)
err <- mean(as.numeric(pred > 0.5) != test_labels)
print(paste("test-error=", err))
predictions<- (as.numeric(pred > 0.5) != test_labels)
predictions<-as.integer(predictions)
```
#confusion matrix
```{r}


conf_df <- data.frame(table(test_df$attrition, predictions))
ggplot(data =  conf_df, mapping = aes(x = predictions, y = Var1)) +
  geom_tile(aes(fill = Freq), colour = "white") +
  geom_text(aes(label = sprintf("%1.0f", Freq)), vjust = 1) +
  scale_fill_gradient(low = "#F3F781", high = "#58FA82") +
  theme_economist() + theme(legend.position="none", strip.background = element_blank(), strip.text.x = element_blank(), 
                            plot.title=element_text(hjust=0.5, color="white"), plot.subtitle=element_text(color="white"), plot.background=element_rect(fill="#0D7680"),
                            axis.text.x=element_text(colour="white"), axis.text.y=element_text(colour="white"),
                            axis.title=element_text(colour="white"), 
                            legend.background = element_rect(fill="#FFF9F5",
                                                             size=0.5, linetype="solid", 
                                                             colour ="black")) + 
  labs(title="Confusion Matrix", y="Attrition Status", x="Predictions")


test$Target<-predictions

write.csv(test,file="My _submission.csv", row.names = FALSE)



```
The test cases were chosen such that all of them were belonging to '0' label
